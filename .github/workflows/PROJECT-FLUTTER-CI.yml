name: Project Flutter CI

# PRê³¼ main/develop ë¸Œëœì¹˜ push ì‹œ ìë™ ì‹¤í–‰
# Android, iOS í”Œë«í¼ë§Œ ê²€ì¦ (macOS, Linux, Web ì œì™¸)
on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ í—ˆìš©

permissions:
  contents: read
  pull-requests: write  # PRì— ëŒ“ê¸€ì„ ë‹¬ê¸° ìœ„í•œ ê¶Œí•œ

jobs:
  # ì½”ë“œ í’ˆì§ˆ ê²€ì¦ ì‘ì—…
  analyze:
    name: Code Analysis
    runs-on: ubuntu-latest

    steps:
      # 1. ì €ì¥ì†Œ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. Flutter SDK ì„¤ì¹˜
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.35.3'
          channel: 'stable'
          cache: true

      # 3. ì˜ì¡´ì„± ì„¤ì¹˜
      - name: Install dependencies
        run: flutter pub get

      # 4. í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ ìƒì„± (.env íŒŒì¼ - analyze ì—ëŸ¬ ë°©ì§€)
      - name: Create .env file
        run: |
          cat > .env << 'EOF'
          ${{ secrets.ENV }}
          EOF

      # 5. ì½”ë“œ í¬ë§·íŒ… ê²€ì‚¬
      - name: Check formatting
        id: format_check
        continue-on-error: true
        run: |
          dart format --set-exit-if-changed . 2>&1 | tee format_output.txt
          exit ${PIPESTATUS[0]}

      # 6. ì •ì  ë¶„ì„
      - name: Analyze code
        id: analyze_check
        continue-on-error: true
        run: |
          flutter analyze 2>&1 | tee analyze_output.txt
          exit ${PIPESTATUS[0]}

      # 7. PRì— ê²°ê³¼ ëŒ“ê¸€ ë‹¬ê¸° (ì‹¤íŒ¨ ì‹œ)
      - name: Comment on PR with issues
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            let commentBody = '## ğŸš¨ Flutter CI ê²€ì‚¬ ì‹¤íŒ¨\n\n';
            let hasIssues = false;

            // í¬ë§·íŒ… ê²€ì‚¬ ê²°ê³¼
            if ('${{ steps.format_check.outcome }}' === 'failure') {
              hasIssues = true;
              commentBody += '### âŒ ì½”ë“œ í¬ë§·íŒ… ê²€ì‚¬ ì‹¤íŒ¨\n\n';
              commentBody += 'ë‹¤ìŒ ëª…ë ¹ì–´ë¡œ ìë™ í¬ë§·íŒ…ì„ ì ìš©í•˜ì„¸ìš”:\n';
              commentBody += '```bash\n';
              commentBody += 'dart format .\n';
              commentBody += '```\n\n';
              
              try {
                const formatOutput = fs.readFileSync('format_output.txt', 'utf8');
                if (formatOutput.trim()) {
                  commentBody += '<details>\n<summary>í¬ë§·íŒ… ì˜¤ë¥˜ ìƒì„¸ ë‚´ìš©</summary>\n\n';
                  commentBody += '```\n' + formatOutput.trim() + '\n```\n\n';
                  commentBody += '</details>\n\n';
                }
              } catch (e) {
                console.log('í¬ë§·íŒ… ì¶œë ¥ íŒŒì¼ì„ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
              }
            }

            // ì •ì  ë¶„ì„ ê²°ê³¼
            if ('${{ steps.analyze_check.outcome }}' === 'failure') {
              hasIssues = true;
              commentBody += '### âŒ ì •ì  ë¶„ì„ ê²€ì‚¬ ì‹¤íŒ¨\n\n';
              
              try {
                const analyzeOutput = fs.readFileSync('analyze_output.txt', 'utf8');
                if (analyzeOutput.trim()) {
                  // ì˜¤ë¥˜/ê²½ê³  ë¼ì¸ ì¶”ì¶œ
                  const lines = analyzeOutput.split('\n');
                  const issues = lines.filter(line => 
                    line.includes('error â€¢') || 
                    line.includes('warning â€¢') ||
                    line.includes('info â€¢')
                  );
                  
                  if (issues.length > 0) {
                    commentBody += 'ë°œê²¬ëœ ë¬¸ì œ:\n\n';
                    commentBody += '```\n';
                    commentBody += issues.slice(0, 20).join('\n');  // ìµœëŒ€ 20ê°œë§Œ í‘œì‹œ
                    if (issues.length > 20) {
                      commentBody += '\n... ê·¸ ì™¸ ' + (issues.length - 20) + 'ê°œì˜ ë¬¸ì œ';
                    }
                    commentBody += '\n```\n\n';
                  }
                  
                  commentBody += '<details>\n<summary>ì „ì²´ ë¶„ì„ ê²°ê³¼ ë³´ê¸°</summary>\n\n';
                  commentBody += '```\n' + analyzeOutput.trim() + '\n```\n\n';
                  commentBody += '</details>\n\n';
                }
              } catch (e) {
                console.log('ë¶„ì„ ì¶œë ¥ íŒŒì¼ì„ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
              }
            }

            if (hasIssues) {
              commentBody += '---\n';
              commentBody += 'ğŸ’¡ **ìˆ˜ì • ë°©ë²•:**\n';
              commentBody += '1. ë¡œì»¬ì—ì„œ `dart format .` ëª…ë ¹ì–´ë¡œ í¬ë§·íŒ… ì ìš©\n';
              commentBody += '2. `flutter analyze` ëª…ë ¹ì–´ë¡œ ì˜¤ë¥˜ í™•ì¸\n';
              commentBody += '3. ì˜¤ë¥˜ë¥¼ ìˆ˜ì •í•œ í›„ ë‹¤ì‹œ ì»¤ë°‹í•˜ì„¸ìš”\n';

              // ê¸°ì¡´ ë´‡ ëŒ“ê¸€ ì°¾ê¸°
              const { data: comments } = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
              });

              const botComment = comments.find(comment => 
                comment.user.type === 'Bot' && 
                comment.body.includes('ğŸš¨ Flutter CI ê²€ì‚¬ ì‹¤íŒ¨')
              );

              if (botComment) {
                // ê¸°ì¡´ ëŒ“ê¸€ ì—…ë°ì´íŠ¸
                await github.rest.issues.updateComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: botComment.id,
                  body: commentBody
                });
              } else {
                // ìƒˆ ëŒ“ê¸€ ì‘ì„±
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  body: commentBody
                });
              }
            }

      # 8. ìµœì¢… ê²°ê³¼ í™•ì¸ (ì‹¤íŒ¨ ì‹œ ì›Œí¬í”Œë¡œìš° ì‹¤íŒ¨)
      - name: Check final status
        if: steps.format_check.outcome == 'failure' || steps.analyze_check.outcome == 'failure'
        run: |
          echo "âŒ CI ê²€ì‚¬ ì‹¤íŒ¨!"
          echo "í¬ë§·íŒ… ê²€ì‚¬: ${{ steps.format_check.outcome }}"
          echo "ì •ì  ë¶„ì„: ${{ steps.analyze_check.outcome }}"
          exit 1
