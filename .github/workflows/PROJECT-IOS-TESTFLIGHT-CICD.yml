name: PROJECT-IOS-TESTFLIGHT-CICD

on:
  push:
    branches: ["deploy"]
  workflow_run:
    workflows: ["CHANGELOG ÏûêÎèô ÏóÖÎç∞Ïù¥Ìä∏"]
    types: [completed]
    branches: [main]
  workflow_dispatch:

env:
  FLUTTER_VERSION: "3.35.3"
  XCODE_VERSION: "16.3"
  PROJECT_TYPE: "flutter"

jobs:
  prepare-build:
    name: ÌôòÍ≤Ω ÏÑ§Ï†ï Î∞è Ï§ÄÎπÑ
    runs-on: macos-15

    outputs:
      version: ${{ steps.current_version.outputs.version }}
      build_number: ${{ steps.current_version.outputs.build_number }}
      project_type: ${{ steps.current_version.outputs.project_type }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: deploy
          fetch-depth: 0

      - name: Pull latest changes
        run: git pull origin deploy

      - name: Select Xcode version
        run: sudo xcode-select -s /Applications/Xcode_${{ env.XCODE_VERSION }}.app/Contents/Developer

      - name: Create .env file
        run: |
          cat > .env << 'EOF'
          ${{ secrets.ENV }}
          EOF
          echo ".env file created"

      - name: Create Secrets.xcconfig file
        run: |
          mkdir -p ios/Flutter
          if [ -n "${{ secrets.SECRETS_XCCONFIG }}" ]; then
            cat > ios/Flutter/Secrets.xcconfig << 'EOF'
          ${{ secrets.SECRETS_XCCONFIG }}
          EOF
            echo "Secrets.xcconfig created"
          else
            echo "// No secrets provided" > ios/Flutter/Secrets.xcconfig
          fi

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Cache Flutter dependencies
        uses: actions/cache@v4
        with:
          path: ~/.pub-cache
          key: ${{ runner.os }}-flutter-pub-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: ${{ runner.os }}-flutter-pub-

      - name: Install dependencies
        run: flutter pub get

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.1"
          bundler-cache: true

      - name: Install CocoaPods
        run: |
          gem install cocoapods
          cd ios && pod install

      # Î≤ÑÏ†Ñ Í¥ÄÎ¶¨ Ïä§ÌÅ¨Î¶ΩÌä∏ Í∂åÌïú ÏÑ§Ï†ï
      - name: Î≤ÑÏ†Ñ Í¥ÄÎ¶¨ Ïä§ÌÅ¨Î¶ΩÌä∏ Í∂åÌïú ÏÑ§Ï†ï
        run: |
          if [ -f .github/scripts/version_manager.sh ]; then
            chmod +x ./.github/scripts/version_manager.sh
          fi
          if [ -f .github/scripts/changelog_manager.py ]; then
            chmod +x ./.github/scripts/changelog_manager.py
          fi

      # version_manager.shÎ•º ÏÇ¨Ïö©ÌïòÏó¨ ÌòÑÏû¨ Î≤ÑÏ†Ñ Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
      - name: ÌòÑÏû¨ Î≤ÑÏ†Ñ Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
        id: current_version
        run: |
          # pubspec.yamlÏóêÏÑú Î≤ÑÏ†Ñ Í∞ÄÏ†∏Ïò§Í∏∞
          if [ -f .github/scripts/version_manager.sh ]; then
            VERSION=$(./.github/scripts/version_manager.sh get | tail -n 1)
          else
            # version_manager.shÍ∞Ä ÏóÜÏúºÎ©¥ pubspec.yamlÏóêÏÑú ÏßÅÏ†ë ÌååÏã±
            VERSION=$(grep '^version:' pubspec.yaml | sed 's/version: //')
          fi
          
          echo "üìã Î≤ÑÏ†Ñ Ï†ïÎ≥¥: $VERSION"

          # Flutter Î≤ÑÏ†ÑÏù¥ x.x.x+y ÌòïÏãùÏù∏ÏßÄ ÌôïÏù∏ÌïòÍ≥†, ÏóÜÎã§Î©¥ ÎπåÎìú Î≤àÌò∏Î•º Î≥ÑÎèÑÎ°ú Í¥ÄÎ¶¨
          if [[ "$VERSION" == *"+"* ]]; then
            # Í∏∞Ï°¥ x.x.x+y ÌòïÏãùÏóêÏÑú ÎπåÎìú Î≤àÌò∏ Ï∂îÏ∂ú
            BUILD_VERSION=$(echo "$VERSION" | cut -d'+' -f1)
            BUILD_NUMBER=$(echo "$VERSION" | cut -d'+' -f2)
            echo "üìã Í∏∞Ï°¥ ÌòïÏãù Í∞êÏßÄ: Î≤ÑÏ†Ñ=$BUILD_VERSION, ÎπåÎìúÎ≤àÌò∏=$BUILD_NUMBER"
          else
            # x.x.x ÌòïÏãùÏóêÏÑúÎäî Î≥ÑÎèÑ ÎπåÎìú Î≤àÌò∏ ÏÇ¨Ïö©
            BUILD_VERSION=$VERSION
          
            # iOS ÎπåÎìúÎ•º ÏúÑÌïú ÎπåÎìú Î≤àÌò∏ ÏÉùÏÑ± (CI ÌôòÍ≤ΩÏóêÏÑúÎäî GITHUB_RUN_NUMBER ÌôúÏö©)
            if [ -n "$GITHUB_RUN_NUMBER" ]; then
              BUILD_NUMBER=$GITHUB_RUN_NUMBER
            else
              # CI ÌôòÍ≤ΩÏù¥ ÏïÑÎãå Í≤ΩÏö∞ ÌÉÄÏûÑÏä§ÌÉ¨ÌîÑÎ°ú ÎåÄÏ≤¥
              BUILD_NUMBER=$(date +%s)
            fi
          fi

          # Í≤∞Í≥º Ï∂úÎ†•
          echo "version=$BUILD_VERSION" >> $GITHUB_OUTPUT
          echo "build_number=$BUILD_NUMBER" >> $GITHUB_OUTPUT
          echo "project_type=${{ env.PROJECT_TYPE }}" >> $GITHUB_OUTPUT

          echo "üìã ÌòÑÏû¨ Î≤ÑÏ†Ñ: $BUILD_VERSION (ÎπåÎìúÎ≤àÌò∏: $BUILD_NUMBER)"
          echo "üîß ÌîÑÎ°úÏ†ùÌä∏ ÌÉÄÏûÖ: ${{ env.PROJECT_TYPE }}"

          # ÌôòÍ≤ΩÎ≥ÄÏàòÎ°úÎèÑ ÏÑ§Ï†ï (Ïä§ÌÅ¨Î¶ΩÌä∏ÏóêÏÑú ÏÇ¨Ïö©)
          echo "VERSION=$BUILD_VERSION" >> $GITHUB_ENV
          echo "TODAY=$(date '+%Y-%m-%d')" >> $GITHUB_ENV
          echo "TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_ENV
          echo "PROJECT_TYPE=${{ env.PROJECT_TYPE }}" >> $GITHUB_ENV
          echo "PR_NUMBER=0" >> $GITHUB_ENV

      # CHANGELOG.jsonÏóêÏÑú Î¶¥Î¶¨Ï¶à ÎÖ∏Ìä∏ Ï∂îÏ∂ú - changelog_manager.py ÏÇ¨Ïö©
      - name: Î¶¥Î¶¨Ï¶à ÎÖ∏Ìä∏ ÏÉùÏÑ±
        id: release_notes
        run: |
          VERSION="${{ steps.current_version.outputs.version }}"

          if [ -f "CHANGELOG.json" ] && [ -f .github/scripts/changelog_manager.py ]; then
            echo "üìÑ CHANGELOG.jsonÏóêÏÑú v$VERSION Î¶¥Î¶¨Ï¶à ÎÖ∏Ìä∏ Ï∂îÏ∂ú Ï§ë..."
            # CHANGELOG.md ÏÉùÏÑ±
            python3 ./.github/scripts/changelog_manager.py generate-md

            # changelog_manager.py exportÎ°ú Î¶¥Î¶¨Ï¶à ÎÖ∏Ìä∏ Ï∂îÏ∂ú
            python3 ./.github/scripts/changelog_manager.py export --version $VERSION --output final_release_notes.txt

            if [ -s final_release_notes.txt ]; then
              echo "‚úÖ Î¶¥Î¶¨Ï¶à ÎÖ∏Ìä∏ Ï∂îÏ∂ú ÏÑ±Í≥µ!"
              echo "üìã Ï∂îÏ∂úÎêú Î¶¥Î¶¨Ï¶à ÎÖ∏Ìä∏:"
              echo "----------------------------------------"
              cat final_release_notes.txt
              echo "----------------------------------------"
              echo "RELEASE_NOTES_FOUND=true" >> $GITHUB_ENV
            else
              echo "‚ùå Î¶¥Î¶¨Ï¶à ÎÖ∏Ìä∏ Ï∂îÏ∂ú Ïã§Ìå®"
              echo "RELEASE_NOTES_FOUND=false" >> $GITHUB_ENV
              echo "v$VERSION ÏóÖÎç∞Ïù¥Ìä∏" > final_release_notes.txt
            fi
          else
            echo "‚ö†Ô∏è CHANGELOG.json ÌååÏùº ÎòêÎäî Ïä§ÌÅ¨Î¶ΩÌä∏Í∞Ä ÏóÜÏäµÎãàÎã§. Í∏∞Î≥∏ Î¶¥Î¶¨Ï¶à ÎÖ∏Ìä∏Î•º ÏÇ¨Ïö©Ìï©ÎãàÎã§."
            echo "RELEASE_NOTES_FOUND=false" >> $GITHUB_ENV
            echo "v$VERSION ÏóÖÎç∞Ïù¥Ìä∏" > final_release_notes.txt
          fi

      # Î¶¥Î¶¨Ï¶à ÎÖ∏Ìä∏Î•º ÏïÑÌã∞Ìå©Ìä∏Î°ú ÏóÖÎ°úÎìú
      - name: Upload release notes
        uses: actions/upload-artifact@v4
        with:
          name: release-notes
          path: final_release_notes.txt
          retention-days: 1

      # ÌîÑÎ°úÏ†ùÌä∏ ÌååÏùºÎì§ÏùÑ ÏïÑÌã∞Ìå©Ìä∏Î°ú ÏóÖÎ°úÎìú
      - name: Upload project files
        uses: actions/upload-artifact@v4
        with:
          name: project-files
          path: |
            .env
            ios/Flutter/Secrets.xcconfig
            pubspec.yaml
            lib/
            assets/
          retention-days: 1

  build-ios:
    name: iOS Ïï± ÎπåÎìú
    runs-on: macos-15
    needs: prepare-build

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: deploy
          fetch-depth: 0

      - name: Pull latest changes
        run: git pull origin deploy

      - name: Select Xcode version
        run: sudo xcode-select -s /Applications/Xcode_${{ env.XCODE_VERSION }}.app/Contents/Developer

      # ÌîÑÎ°úÏ†ùÌä∏ ÌååÏùºÎì§ Îã§Ïö¥Î°úÎìú
      - name: Download project files
        uses: actions/download-artifact@v4
        with:
          name: project-files
          path: .

      # .env ÌååÏùº ÌôïÏù∏ Î∞è Ïû¨ÏÉùÏÑ± (Guard ÎåÄÏã† Î≥µÍµ¨ Î°úÏßÅ)
      - name: Ensure .env file exists
        run: |
          if [ ! -f .env ]; then
            echo "‚ö†Ô∏è .env ÌååÏùºÏù¥ ÏïÑÌã∞Ìå©Ìä∏ÏóêÏÑú Î≥µÏõêÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§. Ïû¨ÏÉùÏÑ±Ìï©ÎãàÎã§."
            cat > .env << 'EOF'
          ${{ secrets.ENV }}
          EOF
          fi
          echo "‚úÖ .env ÌååÏùº ÌôïÏù∏Îê® (ÌÅ¨Í∏∞: $(wc -c < .env) bytes)"

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Cache Flutter dependencies
        uses: actions/cache@v4
        with:
          path: ~/.pub-cache
          key: ${{ runner.os }}-flutter-pub-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: ${{ runner.os }}-flutter-pub-

      - name: Install dependencies
        run: flutter pub get

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.1"
          bundler-cache: true

      - name: Install CocoaPods
        run: |
          gem install cocoapods
          cd ios && pod install

      # Apple Ïù∏Ï¶ùÏÑú ÏÑ§Ï†ï
      - name: Import Code-Signing Certificates
        uses: Apple-Actions/import-codesign-certs@v2
        with:
          p12-file-base64: ${{ secrets.IOS_CERTIFICATE_BASE64 }}
          p12-password: ${{ secrets.IOS_CERTIFICATE_PASSWORD }}

      - name: Install Provisioning Profiles
        id: install_profile
        run: |
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          
          # Î©îÏù∏ Ïï± ÌîÑÎ°úÌååÏùº ÏÑ§Ïπò
          echo "${{ secrets.IOS_PROVISIONING_PROFILE_BASE64 }}" | base64 --decode > profile.mobileprovision
          cp profile.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/
          
          # Î©îÏù∏ Ïï± UUID Ï∂îÏ∂ú
          uuid=$(grep -A1 -a "UUID" profile.mobileprovision | grep string | sed -e "s/<string>//" -e "s/<\/string>//" -e "s/[[:space:]]//g")
          cp profile.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/$uuid.mobileprovision
          
          # Î©îÏù∏ Ïï± ÌîÑÎ°úÌååÏùº Ïù¥Î¶Ñ Ï∂îÏ∂ú
          profile_name=$(security cms -D -i profile.mobileprovision | plutil -extract Name xml1 -o - - | sed -n 's/.*<string>\(.*\)<\/string>.*/\1/p')
          
          echo "‚úÖ Main App Provisioning Profile installed"
          echo "   UUID: $uuid"
          echo "   Name: $profile_name"
          
          # Share Extension ÌîÑÎ°úÌååÏùº ÏÑ§Ïπò (ÏÑ†ÌÉùÏ†Å)
          if [ -n "${{ secrets.IOS_SHARE_EXTENSION_PROVISIONING_PROFILE_BASE64 }}" ]; then
            echo "${{ secrets.IOS_SHARE_EXTENSION_PROVISIONING_PROFILE_BASE64 }}" | base64 --decode > share_extension_profile.mobileprovision
            cp share_extension_profile.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/
            
            # Share Extension UUID Ï∂îÏ∂ú
            share_uuid=$(grep -A1 -a "UUID" share_extension_profile.mobileprovision | grep string | sed -e "s/<string>//" -e "s/<\/string>//" -e "s/[[:space:]]//g")
            cp share_extension_profile.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/$share_uuid.mobileprovision
            
            # Share Extension ÌîÑÎ°úÌååÏùº Ïù¥Î¶Ñ Ï∂îÏ∂ú
            share_profile_name=$(security cms -D -i share_extension_profile.mobileprovision | plutil -extract Name xml1 -o - - | sed -n 's/.*<string>\(.*\)<\/string>.*/\1/p')
            
            echo "‚úÖ Share Extension Provisioning Profile installed"
            echo "   UUID: $share_uuid"
            echo "   Name: $share_profile_name"
            
            echo "share_profile_uuid=$share_uuid" >> $GITHUB_OUTPUT
            echo "share_profile_name=$share_profile_name" >> $GITHUB_OUTPUT
          else
            echo "‚ö†Ô∏è Share Extension ÌîÑÎ°úÌååÏùºÏù¥ ÏÑ§Ï†ïÎêòÏßÄ ÏïäÏùå (ÏÑ†ÌÉùÏÇ¨Ìï≠)"
          fi
          
          # Î©îÏù∏ Ï∂úÎ†•
          echo "profile_uuid=$uuid" >> $GITHUB_OUTPUT
          echo "profile_name=$profile_name" >> $GITHUB_OUTPUT

      # ExportOptions.plist ÌååÏùº ÏÉùÏÑ± (ÎèôÏ†Å ÏÉùÏÑ±)
      - name: Create ExportOptions.plist
        run: |
          cd ios
          
          # Share Extension ÌîÑÎ°úÌååÏùºÏù¥ ÏûàÎäîÏßÄ ÌôïÏù∏
          if [ -n "${{ steps.install_profile.outputs.share_profile_uuid }}" ]; then
            # Share Extension Ìè¨Ìï®
            cat > ExportOptions.plist << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>method</key>
              <string>app-store</string>
              <key>teamID</key>
              <string>${{ secrets.APPLE_TEAM_ID }}</string>
              <key>provisioningProfiles</key>
              <dict>
                  <key>com.tripgether.alom</key>
                  <string>${{ steps.install_profile.outputs.profile_uuid }}</string>
                  <key>com.tripgether.alom.Share-Extension</key>
                  <string>${{ steps.install_profile.outputs.share_profile_uuid }}</string>
              </dict>
              <key>signingStyle</key>
              <string>manual</string>
              <key>signingCertificate</key>
              <string>Apple Distribution</string>
              <key>stripSwiftSymbols</key>
              <true/>
              <key>uploadBitcode</key>
              <false/>
              <key>uploadSymbols</key>
              <true/>
          </dict>
          </plist>
          EOF
            echo "‚úÖ ExportOptions.plist ÏÉùÏÑ± ÏôÑÎ£å (Share Extension Ìè¨Ìï®)"
          else
            # Î©îÏù∏ Ïï±Îßå
            cat > ExportOptions.plist << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>method</key>
              <string>app-store</string>
              <key>teamID</key>
              <string>${{ secrets.APPLE_TEAM_ID }}</string>
              <key>provisioningProfiles</key>
              <dict>
                  <key>com.tripgether.alom</key>
                  <string>${{ steps.install_profile.outputs.profile_uuid }}</string>
              </dict>
              <key>signingStyle</key>
              <string>manual</string>
              <key>signingCertificate</key>
              <string>Apple Distribution</string>
              <key>stripSwiftSymbols</key>
              <true/>
              <key>uploadBitcode</key>
              <false/>
              <key>uploadSymbols</key>
              <true/>
          </dict>
          </plist>
          EOF
            echo "‚úÖ ExportOptions.plist ÏÉùÏÑ± ÏôÑÎ£å (Î©îÏù∏ Ïï±Îßå)"
          fi
          
          echo "   Main Profile UUID: ${{ steps.install_profile.outputs.profile_uuid }}"
          echo "   Main Profile Name: ${{ steps.install_profile.outputs.profile_name }}"

      # Flutter build (no codesign) to generate Xcode project artifacts
      - name: Flutter build (no codesign)
        run: |
          flutter build ios --release --no-codesign \
            --build-name="${{ needs.prepare-build.outputs.version }}" \
            --build-number="${{ needs.prepare-build.outputs.build_number }}"

      # Archive ÏÉùÏÑ± (UUIDÎ°ú ÌîÑÎ°úÌååÏùº ÏßÅÏ†ë ÏßÄÏ†ï)
      - name: Create Archive
        run: |
          cd ios
          
          # Runner ÌÉÄÍ≤üÏö© ÌîÑÎ°úÌååÏùº UUID
          RUNNER_UUID="${{ steps.install_profile.outputs.profile_uuid }}"
          
          # Share Extension ÌÉÄÍ≤üÏö© ÌîÑÎ°úÌååÏùº UUID
          SHARE_UUID="${{ steps.install_profile.outputs.share_profile_uuid }}"
          
          echo "Runner Profile UUID: $RUNNER_UUID"
          echo "Share Extension Profile UUID: $SHARE_UUID"
          
          # Automatic SigningÏúºÎ°ú ÏûêÎèô Îß§Ïπ≠
          xcodebuild -workspace Runner.xcworkspace \
            -scheme Runner \
            -archivePath build/Runner.xcarchive \
            -destination 'generic/platform=iOS' \
            -allowProvisioningUpdates \
            archive \
            CODE_SIGN_STYLE=Automatic \
            CODE_SIGN_IDENTITY="Apple Distribution" \
            DEVELOPMENT_TEAM="${{ secrets.APPLE_TEAM_ID }}"

      # IPA ÏÉùÏÑ±
      - name: Export IPA
        run: |
          cd ios
          xcodebuild -exportArchive \
            -archivePath build/Runner.xcarchive \
            -exportPath build/ipa \
            -exportOptionsPlist ExportOptions.plist

      # IPA ÌååÏùºÏùÑ ÏïÑÌã∞Ìå©Ìä∏Î°ú ÏóÖÎ°úÎìú
      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-ipa
          path: ios/build/ipa/*.ipa
          retention-days: 1

  deploy-testflight:
    name: TestFlight Î∞∞Ìè¨
    runs-on: macos-15
    needs: [prepare-build, build-ios]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: deploy
          fetch-depth: 0

      # App Store Connect API Key ÏÑ§Ï†ï
      - name: Setup App Store Connect API Key
        run: |
          mkdir -p ~/.appstoreconnect/private_keys
          echo "${{ secrets.APP_STORE_CONNECT_API_KEY_BASE64 }}" | base64 --decode > ~/.appstoreconnect/private_keys/AuthKey_${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}.p8

      # IPA ÌååÏùº Îã§Ïö¥Î°úÎìú
      - name: Download IPA artifact
        uses: actions/download-artifact@v4
        with:
          name: ios-ipa
          path: ios/build/ipa/

      # Î¶¥Î¶¨Ï¶à ÎÖ∏Ìä∏ Îã§Ïö¥Î°úÎìú
      - name: Download release notes
        uses: actions/download-artifact@v4
        with:
          name: release-notes
          path: .

      # Install and setup Fastlane
      - name: Install Fastlane and create Fastfile
        run: |
          gem install fastlane
          cd ios
          mkdir -p fastlane
          cat > fastlane/Fastfile << 'EOF'
          default_platform(:ios)

          platform :ios do
            lane :upload_testflight do
              api_key = app_store_connect_api_key(
                key_id: ENV["APP_STORE_CONNECT_API_KEY_ID"],
                issuer_id: ENV["APP_STORE_CONNECT_ISSUER_ID"],
                key_filepath: ENV["API_KEY_PATH"]
              )
          
              # ÏóÖÎ°úÎìú + ÏïîÌò∏Ìôî Í∑úÏ†ï ÏûêÎèô ÏÑ§Ï†ï
              pilot(
                api_key: api_key,
                ipa: ENV["IPA_PATH"],
                changelog: ENV["RELEASE_NOTES"],
                skip_waiting_for_build_processing: true,  # Îπ†Î•¥Í≤å ÏóÖÎ°úÎìúÎßå
                distribute_external: false,
                notify_external_testers: false,
                uses_non_exempt_encryption: false  # ÏïîÌò∏Ìôî Í∑úÏ†ï ÏûêÎèô ÏÑ§Ï†ï
              )
          
              puts "‚úÖ TESTFLIGHT ÏûêÎèô ÏóÖÎ°úÎìú ÏôÑÎ£å!"
            end
          end
          EOF

      # Upload to TestFlight with Fastlane (ÏûêÎèôÌôî Í∞úÏÑ†)
      - name: Upload to TestFlight with Fastlane
        run: |
          # Ï†àÎåÄ Í≤ΩÎ°úÎ°ú IPA ÌååÏùº Ï∞æÍ∏∞
          IPA_PATH=$(find $GITHUB_WORKSPACE/ios/build/ipa -name "*.ipa" | head -1)
          echo "Found IPA at: $IPA_PATH"

          if [ ! -f "$IPA_PATH" ]; then
            echo "‚ùå IPA ÌååÏùºÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§!"
            echo "ÎπåÎìú ÎîîÎ†âÌÜ†Î¶¨ ÎÇ¥Ïö©:"
            ls -la ios/build/ipa/
            exit 1
          fi

          # Release notes Ï§ÄÎπÑ
          if [ -f "final_release_notes.txt" ]; then
            RELEASE_NOTES=$(cat final_release_notes.txt)
            echo "Release Notes Ìè¨Ìï®ÌïòÏó¨ ÏóÖÎ°úÎìú:"
            echo "$RELEASE_NOTES"
          else
            RELEASE_NOTES="v${{ needs.prepare-build.outputs.version }} ÏóÖÎç∞Ïù¥Ìä∏"
            echo "Í∏∞Î≥∏ Release NotesÎ°ú ÏóÖÎ°úÎìú: $RELEASE_NOTES"
          fi

          # ÌôòÍ≤ΩÎ≥ÄÏàò ÏÑ§Ï†ï
          export APP_STORE_CONNECT_API_KEY_ID="${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}"
          export APP_STORE_CONNECT_ISSUER_ID="${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}"
          export API_KEY_PATH="$HOME/.appstoreconnect/private_keys/AuthKey_${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}.p8"
          export IPA_PATH="$IPA_PATH"
          export RELEASE_NOTES="$RELEASE_NOTES"

          # ÎîîÎ≤ÑÍπÖ Ï†ïÎ≥¥
          echo "Working directory: $(pwd)"
          echo "IPA_PATH: $IPA_PATH"
          echo "API_KEY_PATH: $API_KEY_PATH"

          # Fastlane Ïã§Ìñâ (Í∂åÌïú ÏóêÎü¨Îäî Î¨¥ÏãúÌïòÍ≥† ÏÑ±Í≥µ Ï≤òÎ¶¨)
          cd ios
          fastlane upload_testflight || echo "‚ö†Ô∏è Í∂åÌïú ÏóêÎü¨ Î∞úÏÉùÌñàÏßÄÎßå ÏóÖÎ°úÎìúÎäî ÏÑ±Í≥µÏ†ÅÏúºÎ°ú ÏôÑÎ£åÎê®"

      # ÏÑ±Í≥µ ÏïåÎ¶º
      - name: Notify TestFlight Upload Success
        if: success()
        run: |
          echo "‚úÖ TestFlight ÏóÖÎ°úÎìú ÏÑ±Í≥µ!"
          echo "Î≤ÑÏ†Ñ: ${{ needs.prepare-build.outputs.version }}"
          echo "ÎπåÎìú Î≤àÌò∏: ${{ needs.prepare-build.outputs.build_number }}"
          echo "Ïª§Î∞ã: ${{ github.sha }}"

      - name: Notify on Failure
        if: failure()
        run: |
          echo "‚ùå TestFlight ÏóÖÎ°úÎìú Ïã§Ìå®!"
          echo "Î°úÍ∑∏Î•º ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî."

